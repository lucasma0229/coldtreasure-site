<header class="topbar" data-topbar>
  <a class="brand-lockup" href="/" aria-label="ColdTreasure Home">
    <div class="brand-text">
      <div class="brand-name">COLD TREASURE</div>
      <div class="brand-slogan">ARCHIVE IS NOT FOR RESALE</div>
    </div>
  </a>

  <nav class="nav" aria-label="Primary">
    <a href="/news/">News</a>
    <a href="/record/">Record</a>
    <a href="/archive/">Archive</a>
  </nav>

  <!-- ✅ Search：用 form 提交，Enter 必跳转（不依赖 JS） -->
  <form class="ct-search" role="search" action="/news/" method="GET" aria-label="Site search">
    <input
      id="ctSearchInput"
      name="q"
      type="search"
      placeholder="Search…"
      autocomplete="off"
    />
  </form>
</header>

<style>
  /* ✅ 极小样式：不依赖 news.css，也不碰 main.css，避免误伤 */
  .ct-search{ margin-left:14px; display:flex; align-items:center; }
  .ct-search input{
    width: 180px;
    max-width: 42vw;
    height: 34px;
    padding: 0 12px;
    border: 1px solid rgba(18,18,18,.14);
    border-radius: 999px;
    background: rgba(255,255,255,.9);
    color: #121212;
    font-size: 13px;
    letter-spacing: .02em;
    outline: none;
  }
  .ct-search input::placeholder{ color: rgba(18,18,18,.55); }
  .ct-search input:focus{
    border-color: rgba(18,18,18,.28);
    background: #fff;
  }
  @media (max-width: 860px){
    .ct-search input{ width: 130px; }
  }
</style>

<script>
(function(){
  // 防止 include 重复插入导致重复绑定
  if (window.CT_HEADER_INITED) return;
  window.CT_HEADER_INITED = true;

  const path = (location.pathname || "/").toLowerCase();
  const topbar = document.querySelector("[data-topbar]");
  if (!topbar) return;

  // ======== Nav active ========
  document.querySelectorAll(".nav a").forEach(a => {
    const href = (a.getAttribute("href") || "").toLowerCase();
    const isNews = (href === "/news/") && (path.startsWith("/news") || path.startsWith("/post"));
    const isSection = (href !== "/news/") && href !== "/" && path.startsWith(href);
    if (isNews || isSection) a.classList.add("is-active");
  });

  // ======== Search: 回填 q（可选，但很实用） ========
  const input = document.getElementById("ctSearchInput");
  if (input) {
    try{
      const q = new URL(location.href).searchParams.get("q") || "";
      if (q) input.value = q;
    }catch(e){}
  }

  // ======== Home detection ========
  const isHome =
    (String(window.CT_PAGE || "").toLowerCase() === "home") ||
    document.body.classList.contains("page-home") ||
    path === "/" || path === "/index.html";

  function syncNavH(){
    const h = Math.round(topbar.getBoundingClientRect().height || 72);
    document.documentElement.style.setProperty("--navH", h + "px");
  }

  function applyState(){
    syncNavH();
    const y = window.scrollY || document.documentElement.scrollTop || 0;

    if (!isHome){
      document.documentElement.classList.remove("ct-nav--overlay");
      document.documentElement.classList.add("ct-nav--solid");
      return;
    }

    if (y <= 8){
      document.documentElement.classList.add("ct-nav--overlay");
      document.documentElement.classList.remove("ct-nav--solid");
    }else{
      document.documentElement.classList.remove("ct-nav--overlay");
      document.documentElement.classList.add("ct-nav--solid");
    }
  }

  requestAnimationFrame(applyState);
  window.addEventListener("scroll", applyState, { passive:true });
  window.addEventListener("resize", applyState);
})();
</script>
