<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ColdTreasure — Cover Crop Tool</title>

  <!-- Cropper.js (CDN) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.min.css">

  <style>
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "PingFang SC", "Microsoft YaHei", sans-serif;
      color:#121212;
      background:#fff;
    }
    .wrap{
      max-width:1200px;
      margin:0 auto;
      padding:18px 18px 40px;
      display:grid;
      grid-template-columns: 1.3fr .7fr;
      gap:18px;
    }
    .top{
      max-width:1200px;
      margin:0 auto;
      padding:18px 18px 0;
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:16px;
    }
    h1{ margin:0; font-size:18px; letter-spacing:.06em; text-transform:uppercase; }
    .muted{ opacity:.7; font-size:12px; letter-spacing:.04em; }

    .panel{
      border:1px solid rgba(18,18,18,.10);
      border-radius:14px;
      overflow:hidden;
      background:#fff;
    }
    .panel h2{
      margin:0;
      padding:12px 12px;
      border-bottom:1px solid rgba(18,18,18,.08);
      font-size:12px;
      letter-spacing:.12em;
      text-transform:uppercase;
      opacity:.8;
    }
    .panel .content{ padding:12px; }

    .toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      margin-bottom:10px;
    }
    .btn, select, input[type="text"]{
      font:inherit;
      font-size:12px;
      padding:8px 10px;
      border:1px solid rgba(18,18,18,.14);
      border-radius:10px;
      background:#fff;
    }
    .btn{ cursor:pointer; }
    .btn:active{ opacity:.85; }

    .stage{
      position:relative;
      background:rgba(0,0,0,.03);
      min-height:520px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .stage img{
      max-width:100%;
      display:block;
    }

    .preview{
      width:100%;
      aspect-ratio: 3/2;
      border:1px solid rgba(18,18,18,.10);
      border-radius:14px;
      overflow:hidden;
      background:rgba(0,0,0,.03);
    }
    .kv{
      font-size:12px;
      line-height:1.6;
      background:rgba(0,0,0,.02);
      border:1px solid rgba(18,18,18,.10);
      border-radius:12px;
      padding:10px;
      white-space:pre-wrap;
      word-break:break-word;
    }

    @media (max-width: 980px){
      .wrap{ grid-template-columns: 1fr; }
      .stage{ min-height:420px; }
    }
  </style>
</head>
<body>
  <div class="top">
    <div>
      <h1>Cover Crop Tool</h1>
      <div class="muted">像公众号后台一样：裁切 / 旋转 / 缩放 → 导出锁定封面图 + 生成 posts.json 片段</div>
    </div>
  </div>

  <div class="wrap">
    <!-- Left: editor -->
    <div class="panel">
      <h2>Editor</h2>
      <div class="content">
        <div class="toolbar">
          <input id="file" type="file" accept="image/*" class="btn" />
          <input id="url" type="text" placeholder="或粘贴图片 URL（回车加载）" style="flex:1; min-width:220px;">
          <select id="ratio">
            <option value="1.5" selected>3:2（News 列表推荐）</option>
            <option value="1.6">16:10（更横向）</option>
            <option value="1.7777778">16:9</option>
            <option value="NaN">自由裁切</option>
          </select>

          <button class="btn" id="rotL">↺ 左转 5°</button>
          <button class="btn" id="rotR">↻ 右转 5°</button>
          <button class="btn" id="zoomIn">＋ 放大</button>
          <button class="btn" id="zoomOut">－ 缩小</button>
          <button class="btn" id="reset">重置</button>
        </div>

        <div class="toolbar">
          <input id="postId" type="text" placeholder="文章 id（用于建议文件名）例如 foamposite-one-floral-2026" style="flex:1; min-width:260px;">
          <select id="format">
            <option value="image/jpeg" selected>JPG（推荐）</option>
            <option value="image/png">PNG</option>
          </select>
          <input id="quality" type="text" value="0.90" title="JPG质量 0~1" style="width:92px;">
          <button class="btn" id="export">确认并导出</button>
        </div>

        <div class="stage">
          <img id="img" alt="Load an image to start" />
        </div>
      </div>
    </div>

    <!-- Right: preview + json -->
    <div class="panel">
      <h2>Preview & JSON</h2>
      <div class="content">
        <div class="muted" style="margin-bottom:8px;">预览（导出后就是 News 列表锁定封面）</div>
        <div class="preview" id="preview"></div>

        <div class="muted" style="margin:12px 0 8px;">把下面 JSON 片段复制到 posts.json（thumb 路径按你的上传位置调整）</div>
        <div class="kv" id="jsonBox">{ "thumb": "/assets/img/posts/<id>/thumb.jpg" }</div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.min.js"></script>
  <script>
    const $ = (id) => document.getElementById(id);

    const img = $("img");
    const preview = $("preview");
    const ratioSel = $("ratio");
    const urlInput = $("url");
    const fileInput = $("file");
    const postIdInput = $("postId");
    const jsonBox = $("jsonBox");
    const fmtSel = $("format");
    const qualityInput = $("quality");

    let cropper = null;

    function setJsonHint(){
      const id = (postIdInput.value || "<id>").trim() || "<id>";
      jsonBox.textContent = `{ "thumb": "/assets/img/posts/${id}/thumb.jpg" }`;
    }
    postIdInput.addEventListener("input", setJsonHint);
    setJsonHint();

    function destroyCropper(){
      if (cropper){
        cropper.destroy();
        cropper = null;
      }
      preview.innerHTML = "";
    }

    function initCropper(){
      destroyCropper();
      cropper = new Cropper(img, {
        viewMode: 2,
        dragMode: "move",
        autoCropArea: 1,
        responsive: true,
        background: false,
        aspectRatio: parseFloat(ratioSel.value),
        preview: preview,
      });
    }

    ratioSel.addEventListener("change", () => {
      if (!cropper) return;
      const val = parseFloat(ratioSel.value);
      cropper.setAspectRatio(val);
    });

    urlInput.addEventListener("keydown", async (e) => {
      if (e.key !== "Enter") return;
      const url = urlInput.value.trim();
      if (!url) return;

      // 直接加载 URL（需要图片允许跨域，若跨域失败，建议下载后用 file 方式）
      img.crossOrigin = "anonymous";
      img.src = url;
      img.onload = () => initCropper();
      img.onerror = () => alert("URL 加载失败或跨域限制。建议先下载图片再用文件上传。");
    });

    fileInput.addEventListener("change", () => {
      const f = fileInput.files && fileInput.files[0];
      if (!f) return;
      const url = URL.createObjectURL(f);
      img.removeAttribute("crossorigin");
      img.src = url;
      img.onload = () => initCropper();
    });

    $("rotL").onclick = () => cropper && cropper.rotate(-5);
    $("rotR").onclick = () => cropper && cropper.rotate(5);
    $("zoomIn").onclick = () => cropper && cropper.zoom(0.08);
    $("zoomOut").onclick = () => cropper && cropper.zoom(-0.08);
    $("reset").onclick = () => cropper && cropper.reset();

    $("export").onclick = () => {
      if (!cropper) return alert("请先加载一张图片。");

      const id = (postIdInput.value || "post").trim() || "post";
      const mime = fmtSel.value;
      let q = parseFloat(qualityInput.value);
      if (Number.isNaN(q)) q = 0.9;
      q = Math.min(1, Math.max(0.5, q));

      // 你 News 列表现在用 3:2，导出给一个“高清但不夸张”的尺寸
      // 如需更大更小，你告诉我，我按你首页/News 真实展示尺寸定一组。
      const exportW = 1120; // 3:2 -> 1120x747
      const exportH = Math.round(exportW / 1.5);

      const canvas = cropper.getCroppedCanvas({
        width: exportW,
        height: exportH,
        imageSmoothingEnabled: true,
        imageSmoothingQuality: "high",
      });

      canvas.toBlob((blob) => {
        if (!blob) return alert("导出失败。");
        const ext = (mime === "image/png") ? "png" : "jpg";
        const filename = `thumb-${id}.${ext}`;

        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        a.click();
        URL.revokeObjectURL(a.href);

        alert(`已导出：${filename}\n\n下一步：把它上传到\n/assets/img/posts/${id}/thumb.${ext}\n然后在 posts.json 填 thumb 字段。`);
      }, mime, mime === "image/jpeg" ? q : undefined);
    };
  </script>
</body>
</html>
