<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ColdTreasure | Post</title>

  <!-- ✅ 与全站一致：吃同一份主样式（topbar/nav 等都靠它） -->
  <link rel="stylesheet" href="/assets/css/style.css?v=20" />

  <!-- ✅ 文章页自身的排版（不再写 header 的样式，避免覆盖全站 topbar） -->
  <style>
    :root { --w: 980px; --muted:#777; --line:#eee; }

    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans SC", Arial;
      background:#fff;
      color:#111;
    }

    /* ✅ 给文章内容留出呼吸感：不要去动 topbar */
    main{ max-width: var(--w); margin: 24px auto 64px; padding: 0 18px; }

    .meta{ color:var(--muted); font-size:14px; margin: 8px 0 18px; display:flex; flex-wrap:wrap; gap:10px; }
    h1{ font-size:30px; line-height:1.2; margin:0 0 8px; letter-spacing:.2px; }

    .hero{ width:100%; border-radius:14px; overflow:hidden; background:#f6f6f6; border:1px solid var(--line); }
    .hero img{ width:100%; height:auto; display:block; }

    .summary{ font-size:16px; line-height:1.7; margin: 16px 0 6px; color:#222; }

    .content{ margin-top:18px; font-size:16px; line-height:1.85; }
    .content h2{ font-size:18px; margin: 22px 0 10px; }
    .content p{ margin: 12px 0; }
    .content ul{ margin: 10px 0 14px 18px; }

    .gallery{ margin-top:26px; }
    .gallery h2{ font-size:18px; margin:0 0 10px; }
    .grid{ display:grid; grid-template-columns: repeat(2, 1fr); gap:10px; }
    .grid img{ width:100%; height:auto; border-radius:12px; border:1px solid var(--line); background:#f6f6f6; }

    .card{ margin-top:22px; border:1px solid var(--line); border-radius:14px; padding:14px; }
    .card a{ color:#111; }

    .error{ padding:14px; border:1px solid #ffd0d0; background:#fff5f5; border-radius:14px; }
    .muted{ color:var(--muted); }

    @media (max-width: 720px){
      .grid{ grid-template-columns: 1fr; }
      h1{ font-size:26px; }
    }
  </style>
</head>

<body>
  <!-- ✅ 统一导航：直接引用模块（与首页 /news/ 完全一致） -->
  <div data-include="/modules/header/header.html"></div>

  <main id="app">
    <div class="muted">Loading…</div>
  </main>

  <script>
    // ✅ 通用 include loader（如果你全站已经有，就算重复也没事；但为了 post 页独立可用，这里保留）
    (async function includeHTML(){
      const nodes = document.querySelectorAll("[data-include]");
      await Promise.all(Array.from(nodes).map(async (el) => {
        const url = el.getAttribute("data-include");
        if(!url) return;
        try{
          const res = await fetch(url, { cache: "no-store" });
          el.outerHTML = await res.text();
        }catch(e){
          console.warn("Include failed:", url, e);
        }
      }));
    })();
  </script>

  <script>
    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function getId(){
      const u = new URL(location.href);
      return u.searchParams.get("id")?.trim() || "";
    }

    async function loadPosts(){
      // 强制带一个 cache-buster，避免 Cloudflare 缓存导致“我改了但没生效”
      const res = await fetch(`/assets/data/posts.json?v=${Date.now()}`, { cache: "no-store" });
      if(!res.ok) throw new Error(`Failed to load posts.json (${res.status})`);
      return await res.json();
    }

    function renderBlock(block){
      if(!block || !block.type) return "";
      if(block.type === "p") return `<p>${escapeHtml(block.text)}</p>`;
      if(block.type === "h2") return `<h2>${escapeHtml(block.text)}</h2>`;
      if(block.type === "ul"){
        const items = (block.items || []).map(x => `<li>${escapeHtml(x)}</li>`).join("");
        return `<ul>${items}</ul>`;
      }
      return "";
    }

    function render(post){
      const brand = Array.isArray(post.brand) ? post.brand.join(" / ") : (post.brand || "");
      const tags = Array.isArray(post.tags) ? post.tags : [];
      const metaParts = [];
      if(brand) metaParts.push(escapeHtml(brand));
      if(post.date) metaParts.push(escapeHtml(post.date));
      if(tags.length) metaParts.push(tags.map(t => `#${escapeHtml(t)}`).join(" "));

      const heroHtml = post.hero ? `
        <div class="hero">
          <img src="${escapeHtml(post.hero)}" alt="${escapeHtml(post.title)}" loading="eager" />
        </div>
      ` : "";

      const contentHtml = (post.content || []).map(renderBlock).join("");

      const gallery = Array.isArray(post.gallery) ? post.gallery : [];
      const galleryHtml = gallery.length ? `
        <section class="gallery">
          <h2>Gallery</h2>
          <div class="grid">
            ${gallery.map(src => `<img src="${escapeHtml(src)}" alt="" loading="lazy" />`).join("")}
          </div>
        </section>
      ` : "";

      const sourceHtml = post.source_url ? `
        <div class="card">
          <div class="muted">Source</div>
          <div><a href="${escapeHtml(post.source_url)}" target="_blank" rel="noreferrer">${escapeHtml(post.source_url)}</a></div>
        </div>
      ` : "";

      return `
        <article>
          <h1>${escapeHtml(post.title || "Untitled")}</h1>
          <div class="meta">${metaParts.join(" · ")}</div>
          ${heroHtml}
          ${post.summary ? `<div class="summary">${escapeHtml(post.summary)}</div>` : ""}
          <div class="content">${contentHtml}</div>
          ${galleryHtml}
          ${sourceHtml}
        </article>
      `;
    }

    (async function main(){
      const app = document.getElementById("app");
      const id = getId();

      if(!id){
        app.innerHTML = `<div class="error"><b>Missing id</b><div class="muted">URL 需要带参数：<code>?id=xxx</code></div></div>`;
        return;
      }

      try{
        const posts = await loadPosts();
        const post = (Array.isArray(posts) ? posts : []).find(p => p && p.id === id);
        if(!post){
          app.innerHTML = `
            <div class="error">
              <b>Post not found</b>
              <div class="muted">未找到 id = <code>${escapeHtml(id)}</code> 的文章。</div>
              <div class="muted" style="margin-top:8px;">请确认：<code>assets/data/posts.json</code> 中存在同名 id。</div>
            </div>
          `;
          return;
        }
        app.innerHTML = render(post);
      }catch(err){
        app.innerHTML = `
          <div class="error">
            <b>Load failed</b>
            <div class="muted">${escapeHtml(err.message || err)}</div>
            <div class="muted" style="margin-top:8px;">
              重点检查：<code>assets/data/posts.json</code> 文件名是否正确（不是 .jason），以及是否已部署生效（Ctrl+F5）。
            </div>
          </div>
        `;
      }
    })();
  </script>
</body>
</html>
