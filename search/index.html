<!doctype html>
<html lang="zh-Hans">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ColdTreasure | Search</title>

  <link rel="stylesheet" href="/assets/css/main.css?v=220" />

  <script>window.CT_PAGE = "search";</script>
  <script src="/assets/js/include.v3.js?v=12" defer></script>
</head>

<body>
  <div data-include="/modules/header/header.html"></div>

  <main class="page" style="max-width:1240px;margin:22px auto 0;padding:0 26px;">
    <header class="page-head" style="margin:18px 0 18px;">
      <div style="display:flex;align-items:flex-end;justify-content:space-between;gap:16px;">
        <h1 style="margin:0;font-size:38px;letter-spacing:-0.02em;">Search</h1>
        <div style="display:flex;align-items:baseline;gap:10px;color:#6f6f6f;font-size:13px;letter-spacing:.06em;white-space:nowrap;">
          <span style="font-weight:600;text-transform:uppercase;">Results</span>
          <span style="opacity:.5;">•</span>
          <span id="pageStatus" style="opacity:.85;">Loading…</span>
        </div>
      </div>
      <div style="margin-top:14px;height:1px;background:#ececec;opacity:.9;"></div>
    </header>

    <div id="app" class="empty">Loading…</div>

    <div data-include="/modules/footer/footer.html"></div>
  </main>

  <script>
    function esc(s=""){return String(s).replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m]));}
    function norm(s=""){return String(s||"").toLowerCase().trim();}
    function getQ(){ return new URL(location.href).searchParams.get("q")?.trim() || ""; }

    async function loadPosts(){
      const res = await fetch(`/assets/data/posts.json?v=${Date.now()}`, { cache:"no-store" });
      if(!res.ok) throw new Error(`Failed to load posts.json (${res.status})`);
      const data = await res.json();
      return Array.isArray(data) ? data : [];
    }

    // ✅ 搜索权重：title > brand/tags > summary > content text
    function haystack(post){
      const title = post.title || "";
      const brand = Array.isArray(post.brand) ? post.brand.join(" ") : (post.brand || "");
      const tags  = Array.isArray(post.tags) ? post.tags.join(" ") : "";
      const summary = post.summary || "";
      const contentText = Array.isArray(post.content)
        ? post.content.map(b => (b?.text || "") + " " + (Array.isArray(b?.items) ? b.items.join(" ") : "")).join(" ")
        : "";
      return norm([title, brand, tags, summary, contentText].join(" "));
    }

    function score(post, q){
      const t = norm(post.title || "");
      const b = norm(Array.isArray(post.brand)? post.brand.join(" "):(post.brand||""));
      const tags = norm(Array.isArray(post.tags)? post.tags.join(" "):"");
      const s = norm(post.summary || "");
      const h = haystack(post);

      let sc = 0;
      if (t.includes(q)) sc += 5;
      if (b.includes(q)) sc += 3;
      if (tags.includes(q)) sc += 3;
      if (s.includes(q)) sc += 2;
      if (h.includes(q)) sc += 1;
      return sc;
    }

    function renderItem(post){
      const id = post.id || "";
      const title = post.title || id || "Untitled";
      const summary = post.summary || "";
      const date = post.date || post.release_date || "";
      const brand = Array.isArray(post.brand) ? post.brand.join(" / ") : (post.brand || "");
      const hero = post.thumb || post.hero || post.cover || post.image || "";

      const href = `/post/?id=${encodeURIComponent(id)}`;
      const v = encodeURIComponent((date || "1").toString());

      return `
        <article class="news-item">
          <a class="news-media" href="${href}" aria-label="${esc(title)}">
            ${hero ? `<img src="${esc(hero)}?v=${v}" alt="${esc(title)}" loading="lazy">` : ``}
          </a>
          <div class="news-body">
            <div class="news-meta">
              ${brand ? `<span class="pill">${esc(brand)}</span>` : ``}
              ${date ? `<span class="date">${esc(date)}</span>` : ``}
            </div>
            <h2 class="news-title"><a href="${href}">${esc(title)}</a></h2>
            ${summary ? `<p class="news-summary">${esc(summary)}</p>` : ``}
          </div>
        </article>
      `;
    }

    (async function main(){
      const app = document.getElementById("app");
      const statusEl = document.getElementById("pageStatus");

      await new Promise((resolve) => {
        let done = false;
        const finish = () => { if(done) return; done = true; resolve(); };
        document.addEventListener("modules:loaded", finish, { once:true });
        setTimeout(finish, 1200);
      });

      const qRaw = getQ();
      const q = norm(qRaw);

      if(!q){
        if (statusEl) statusEl.textContent = "0 results";
        app.className = "empty";
        app.innerHTML = `请输入关键词搜索（例如：<b>Nike</b> / <b>PSG</b> / <b>KD18</b>）。`;
        return;
      }

      try{
        const posts = await loadPosts();
        const hits = posts
          .map(p => ({ p, sc: score(p, q) }))
          .filter(x => x.sc > 0)
          .sort((a,b) => b.sc - a.sc || String(b.p.date||"").localeCompare(String(a.p.date||"")))
          .map(x => x.p);

        if (statusEl) statusEl.textContent = `${hits.length} results for “${qRaw}”`;

        if(!hits.length){
          app.className = "empty";
          app.innerHTML = `没有找到与 <b>${esc(qRaw)}</b> 相关的文章。`;
          return;
        }

        // ✅ 复用你 News 卡片样式（前提：news.css 为空也没关系，你内联样式也能跑）
        app.className = "";
        app.innerHTML = `<section class="news-list">${hits.map(renderItem).join("")}</section>`;
      }catch(err){
        if (statusEl) statusEl.textContent = "Error";
        app.className = "error";
        app.innerHTML = `<b>Load failed</b><div style="margin-top:8px;">${esc(err.message || err)}</div>`;
      }
    })();
  </script>
</body>
</html>
