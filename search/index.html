<!doctype html>
<html lang="zh-Hans">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ColdTreasure | Search</title>

  <link rel="stylesheet" href="/assets/css/main.css?v=220" />

  <script>window.CT_PAGE = "search";</script>
  <script src="/assets/js/include.v3.js?v=12" defer></script>
</head>

<body>
  <div data-include="/modules/header/header.html"></div>

  <main class="page" style="max-width:1240px;margin:22px auto 0;padding:0 26px;">
    <header class="page-head" style="margin:18px 0 18px;">
      <div style="display:flex;align-items:flex-end;justify-content:space-between;gap:16px;">
        <h1 style="margin:0;font-size:38px;letter-spacing:-0.02em;">Search</h1>
        <div style="display:flex;align-items:baseline;gap:10px;color:#6f6f6f;font-size:13px;letter-spacing:.06em;white-space:nowrap;">
          <span style="font-weight:600;text-transform:uppercase;">Results</span>
          <span style="opacity:.5;">•</span>
          <span id="pageStatus" style="opacity:.85;">Loading…</span>
        </div>
      </div>
      <div style="margin-top:14px;height:1px;background:#ececec;opacity:.9;"></div>
    </header>

    <div id="app" class="empty">Loading…</div>

    <div data-include="/modules/footer/footer.html"></div>
  </main>

  <script>
  // ---------------------------
  // Helpers
  // ---------------------------
  function esc(s=""){return String(s).replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m]));}

  // 强归一化：小写 + 去空格/短横线/下划线/常见标点
  // "NY VS NY"、"nyvsny"、"ny-vs-ny" => "nyvsny"
  function normKey(s=""){
    return String(s||"")
      .toLowerCase()
      .trim()
      .replace(/[\s\-_./\\|:;'"“”‘’()（）[\]【】{}<>!?，。、《》]+/g, "");
  }

  // 宽松归一化：仅小写+trim（用于普通 contains）
  function normLoose(s=""){
    return String(s||"").toLowerCase().trim();
  }

  function getQ(){ return new URL(location.href).searchParams.get("q")?.trim() || ""; }

  // slug 兜底生成（避免 API 缺 slug 导致被过滤/无法跳转）
  function slugifyLoose(s=""){
    const x = String(s || "")
      .toLowerCase()
      .trim()
      .replace(/['"“”‘’]/g, "")
      .replace(/[^a-z0-9]+/g, "-")
      .replace(/-+/g, "-")
      .replace(/^-|-$/g, "");
    return x || "";
  }

  // ---------------------------
  // Data loading (API -> fallback)
  // ---------------------------
  async function loadPosts(){
    // 1) primary: /api/posts
    try{
      const res = await fetch(`/api/posts?v=${Date.now()}`, { cache:"no-store" });
      const data = await res.json().catch(()=>null);

      if(!res.ok){
        throw new Error(data?.error || `Failed to load /api/posts (${res.status})`);
      }

      const arr = Array.isArray(data) ? data : (Array.isArray(data?.posts) ? data.posts : []);
      if(arr && arr.length) return arr;
      // 如果 API 返回空数组，继续走 fallback
    }catch(e){
      // ignore, fallback below
    }

    // 2) fallback: /assets/data/posts.json
    const res2 = await fetch(`/assets/data/posts.json?v=${Date.now()}`, { cache:"no-store" });
    if(!res2.ok) throw new Error(`Failed to load /assets/data/posts.json (${res2.status})`);
    const data2 = await res2.json();
    return Array.isArray(data2) ? data2 : (Array.isArray(data2?.posts) ? data2.posts : []);
  }

  // ---------------------------
  // Search scoring
  // ---------------------------
  function score(post, qRaw){
    const q = normLoose(qRaw);
    const qk = normKey(qRaw);

    const title = normLoose(post.title || "");
    const keywords = normLoose(Array.isArray(post.keywords) ? post.keywords.join(" ") : "");
    const content = normLoose(post.content || "");
    const release = normLoose(post.release_info || "");

    const titleK = normKey(post.title || "");
    const keywordsK = normKey(Array.isArray(post.keywords) ? post.keywords.join(" ") : "");
    const contentK = normKey(post.content || "");

    let sc = 0;

    // 强匹配（归一化）
    if (titleK.includes(qk)) sc += 8;
    if (keywordsK.includes(qk)) sc += 6;
    if (contentK.includes(qk)) sc += 2;

    // 普通 contains（兼容中文、完整短语）
    if (title.includes(q)) sc += 5;
    if (keywords.includes(q)) sc += 4;
    if (release.includes(q)) sc += 2;
    if (content.includes(q)) sc += 1;

    return sc;
  }

  // ---------------------------
  // Render
  // ---------------------------
  function renderItem(post){
    const title = post.title || "Untitled";
    const summary = post.summary || "";
    const date = post.date || "";
    const hero = post.cover || "";
    const slug = String(post.slug || "").trim();

    const href = `/post/?slug=${encodeURIComponent(slug)}`;
    const v = encodeURIComponent((date || "1").toString());

    return `
      <article class="news-item">
        <a class="news-media" href="${href}" aria-label="${esc(title)}">
          ${hero ? `<img src="${esc(hero)}?v=${v}" alt="${esc(title)}" loading="lazy">` : ``}
        </a>
        <div class="news-body">
          <div class="news-meta">
            ${date ? `<span class="date">${esc(date)}</span>` : ``}
          </div>
          <h2 class="news-title"><a href="${href}">${esc(title)}</a></h2>
          ${summary ? `<p class="news-summary">${esc(summary)}</p>` : ``}
        </div>
      </article>
    `;
  }

  // ---------------------------
  // Main
  // ---------------------------
  (async function main(){
    const app = document.getElementById("app");
    const statusEl = document.getElementById("pageStatus");

    // 等 include 模块加载（header/footer）
    await new Promise((resolve) => {
      let done = false;
      const finish = () => { if(done) return; done = true; resolve(); };
      document.addEventListener("modules:loaded", finish, { once:true });
      setTimeout(finish, 1200);
    });

    const qRaw = getQ();

    if(!qRaw){
      if (statusEl) statusEl.textContent = "0 results";
      app.className = "empty";
      app.innerHTML = `请输入关键词搜索（例如：<b>Nike</b> / <b>AJ4</b> / <b>NY VS NY</b> / <b>nyvsny</b>）。`;
      return;
    }

    try{
      const posts = await loadPosts();

      // 统一补 slug（API 没给也不怕）
      const valid = (posts || [])
        .filter(p => p)
        .map(p => {
          const slug = String(p.slug || "").trim() || slugifyLoose(p.title || "");
          return { ...p, slug };
        })
        .filter(p => String(p.slug || "").trim());

      const hits = valid
        .map(p => ({ p, sc: score(p, qRaw) }))
        .filter(x => x.sc > 0)
        .sort((a,b) => b.sc - a.sc || String(b.p.date||"").localeCompare(String(a.p.date||"")))
        .map(x => x.p);

      if (statusEl) statusEl.textContent = `${hits.length} results for “${qRaw}”`;

      if(!hits.length){
        app.className = "empty";
        app.innerHTML = `没有找到与 <b>${esc(qRaw)}</b> 相关的文章。`;
        return;
      }

      app.className = "";
      app.innerHTML = `<section class="news-list">${hits.map(renderItem).join("")}</section>`;
    }catch(err){
      if (statusEl) statusEl.textContent = "Error";
      app.className = "error";
      app.innerHTML = `<b>Load failed</b><div style="margin-top:8px;">${esc(err.message || err)}</div>`;
    }
  })();
  </script>
</body>
</html>
